<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta http-equiv="Cache-Control" content="no-cache,no-store,must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta property="og:title" content="F购商城">
    <meta property="og:description" content="风靡全国的拼团商城，优质商品新鲜直供，快来一起F购吧">
    <title>F购商城</title>
    <style>
        .gosetAd{
            position: relative;
    width: 100%;
    min-height: .74rem;
    background-color: #fff;
    color: #151516;
    font-size:16px;
    overflow-x: hidden;
    -webkit-box-pack: start;
    justify-content: flex-start;
    -webkit-justify-content: flex-start;
    line-height: 0.74rem;
    text-align: center;
        }
    </style>
</head>
<head>
    <link href="https://cdn.yangkeduo.com/assets/css/react_pdd_6fb15092c0312a697dfb.css" rel="stylesheet">
    <link href="https://cdn.yangkeduo.com/assets/css/react_boot_b75c36a0efec6307f981.css" rel="stylesheet">
    <link href="https://cdn.yangkeduo.com/assets/css/react_common_5757ad19c083dcf89e96.css" rel="stylesheet">
</head>

<body id="order_checkout">
    <div id="main" style="height:100%">
        <div class="order-checkout-container " style="" data-reactroot="">
            <div class="oc-address">
                <div class="oc-address-info" data-active="before-white" @click="gosetAd()">
                    <div class="oc-address-location">
                        <div class="oc-address-location-icon"></div>
                    </div>
                    <div class="oc-address-main-info">
                        <div class="oc-address-receiver"><span class="oc-address-receiver-name">{{userName}}</span><span class="oc-address-receiver-mobile">{{userTel}}</span></div>
                        <div class="oc-address-detail">{{userPname}}
                           {{userCname}} {{userAname}}
                           {{userInfo}}</div>
                    </div>
                    <div class="oc-address-right-arrow">
                        <div class="oc-address-right-arrow-icon"></div>
                    </div>
                </div>
                <div class="gosetAd" style="display:none;" @click="gosetAd()">请选择地址</div>
                <div class="bottom-line"></div>
            </div>
            <div class="oc-goods ">
                <div class="oc-goods-mall">
                    <img data-param="80_!_f_!_!_!_!_t_!" :src="goodsDetail.shopLogo">
                    <span>
                        <p class="oc-goods-mall-title">{{goodsDetail.shopName}}</p>
                    </span>
                </div>
                <div class="oc-goods-info">
                    <div class="oc-goods-inherent-info">
                        <div class="oc-goods-thumburl"><img quantity="80" data-param="80_!_f_!_!_!_200_t_!" :src="goodsDetail.gpic"></div>
                        <div class="oc-goods-detail"><span class="oc-goods-name">{{goodsDetail.gname}}</span>
                            <div class="oc-goods-spec">
                                <div class="specification-item">{{goodsDetail.skutext}}</div>
                            </div>
                            <div class="oc-goods-price-block">
                                <div class="oc-goods-price"><i>￥</i>{{goodsDetail.gprice}}<i>/件</i>
                                    <div class="oc-goods-label" style="font-size:0.12rem;color:#339B29;border:1px #339B29 solid">极速退款</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="oc-goods-number"><span>购买数量</span>
                    <div class="oc-goods-number-btn">
                        <input type="number" class="oc-buy-number " id="goodsNum" style="width: 9px;" :value="goodsDetail.num">
                    </div>
                </div>
            </div>
            <div class="oc-safe-pay-statement"><span class="green-shield-icon"></span><span>平台用户信息泄露风险由</span><img
                    class="picc-img" src="//pinduoduoimg.yangkeduo.com/order_checkout/picc_v2.png"><span>承保</span></div>
            <div class="oc-bottom-bar ">
                <div class="oc-pay-final">
                    <div class="oc-caption-block"><span class="oc-pay-title" style="font-size: 0.14rem;">实付款
                            <!-- -->:</span><span class="oc-final-amount"><i>￥</i>{{goodsDetail.gprice*goodsDetail.num}}</span><span class="oc-free-shipping"
                            style="font-size: 0.14rem;">免运费</span></div>
                </div>
                <div class="oc-pay-btn  " data-active="before-red" @click="createdOrder()">立即支付<div id="oc-pay-text"></div>
                </div>
            </div>
            <div class="oc-repay-modify-panel" style="display:none">
                <div class="rmp-content" style="bottom:-4.4rem">
                    <div class="rmp-header">
                        <div class="rmp-count-down">请在
                            <!-- -->00:00.0
                            <!-- -->内支付</div>
                        <div class="rmp-close"></div>
                    </div>
                    <div class="rmp-address-wrap" data-active="before-white">
                        <div class="rmp-address">
                            <div class="rmp-addr-location"></div>
                            <div class="rmp-whole-addr"><span>浙江省
                                    <!-- -->绍兴市
                                    <!-- -->越城区
                                    <!-- -->嘤嘤嘤</span></div>
                        </div>
                    </div>
                    <div class="rmp-confirm">
                        <div class="oc-safe-pay-statement"><span class="green-shield-icon"></span><span>平台用户信息泄露风险由</span><img
                                class="picc-img" src="//pinduoduoimg.yangkeduo.com/order_checkout/picc_v2.png"><span>承保</span></div>
                        <div class="rmp-confirm-button">继续支付<span class="rmp-final-price">￥
                                <!-- -->24.08</span></div>
                    </div>
                </div>
            </div>
            <div id="auto-create-group"></div>

        </div>
    </div>
</body>

<script src="./script/jquery-3.2.1.min.js"></script>
<script src="./script/config.js"></script>
<script src="./script/common.js"></script>
<script src="./script/yltcrypt.js"></script>
<script src="./script/aui-toast.js"></script>
<script src="./script/vue.js"></script>
<script src="./script/mlayer/layer.js"></script>
<script>
    checkLogin();
    var orderParam = JSON.parse(getStorage('orderParam'));
    var param = pageParam();
    new Vue({
        el:"#main",
        data:{
            productOrder:'',
            userName:'',
            userTel:'',
            userPname:'',
            userCname:'',
            userAname:'',
            userInfo:'',
            goodsDetail:orderParam,
        },
        methods:{
            getproductInfo:function(){
                var self = this
            },
            getUserAddress:function(){
                var self = this;
                $.ajax({
                    type: 'POST',
                    url: PHP_SERVE_URL + '/customer/myAddress',
                    data: {
                        openId: userInfo.open_id,
                    },
                    success: function (ret, err) {
                        if (ret.code == 0) {
                            if(ret.data.length == 0){
                                $(".gosetAd").show();
                                $(".oc-address-info").hide();
                            }else{
                                 self.userName = ret.data[0].uname;
                                 self.userTel = ret.data[0].tel;
                                 self.userPname = ret.data[0].pname;
                                 self.userCname = ret.data[0].cname;
                                 self.userAname = ret.data[0].aname;
                                 self.userInfo = ret.data[0].info;
                            }
                        }
                    }
                })
            },
            gosetAd:function(){
                location.href = "set_address.html?back=1";
            },
            createdOrder:function(){
                var self = this;
                var peopleAd = self.userPname+""+ self.userCname+""+self.userAname+""+self.userInfo;
                var peopleInfo = {"name":self.userName,"tel":self.userTel,"address":peopleAd};
                var goods = {"gid":self.goodsDetail.gid,"num":self.goodsDetail.num,"shopId":self.goodsDetail.shopId,"formatIds":self.goodsDetail.formatIds};
                $.ajax({
                    type: 'POST',
                    url: PHP_SERVE_URL + "/shop/buildOrder",
                    data: {
                        openId: userInfo.open_id,
                        goods: JSON.stringify(self.goodsDetail),
                        userInfo:JSON.stringify(peopleInfo),
                        btype:self.goodsDetail.btype,
                    },
                    success: function (ret, res) {
                        if (ret.code == 0) {
                            self.userSign(ret.orderNo);
                        }
                    }
                })
            },
            userSign:function(orderNo){
                var self = this
                $.ajax({
                    type: 'POST',
                    url: PHP_SERVE_URL + "/pay/wxPayLite",
                    data: {
                        orderNo:orderNo,
                    },
                    success: function (ret, res) {
                        if (ret.code == 0) {
                            onBridgeReady(ret.data)
                        }
                    }
                })
            },
        },
        mounted:function(){
            var self = this;
            if(param.itemData != undefined){
                var paramJson = JSON.parse(param.itemData)
                self.userName =paramJson.uname;
                self.userTel = paramJson.tel;
                self.userPname = paramJson.pname;
                self.userCname = paramJson.cname;
                self.userAname = paramJson.aname;
                self.userInfo = paramJson.info;
            }else{
                self.getUserAddress();
            }
        }
    });
    function onBridgeReady(data){
        WeixinJSBridge.invoke(
            'getBrandWCPayRequest', {
                "appId":data.appId,     //公众号名称，由商户传入     
                "timeStamp":data.timeStamp,         //时间戳，自1970年以来的秒数     
                "nonceStr":data.nonceStr, //随机串     
                "package":data.package,     
                "signType":data.signType,         //微信签名方式：     
                "paySign":data.paySign //微信签名 
        },
        function(res){
            if(res.err_msg == "get_brand_wcpay_request:ok" ){
                //支付成功，跳转到订单页面
                layer.open({
                    content: '支付成功'
                    ,skin: 'msg'
                    ,time: 1
                });
                setInterval(function(){location.href='my_order.html?orType=2'}, 1000);
            }else{
                //支付失败
                layer.open({
                    content: '支付失败'
                    ,skin: 'msg'
                    ,time: 2
                });
            }
        });
    }
</script>

</html>